{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Personal Tracker ‚Äì Sessions</title>

  <link rel="icon" href="{% static 'base_tailwind/favicon.ico' %}">
  <link rel="stylesheet" href="{% static 'base_tailwind/style.css' %}">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: {500:'#3b82f6',600:'#2563eb'} }
        }
      }
    }
  </script>

  <!-- Alpine pour le header / dark mode -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    .fade-in { animation: fadeIn .3s ease; }
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    @keyframes pulseCard {0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
    @keyframes flashBg {0%{background:#e2e8f0}50%{background:#bfdbfe}100%{background:#e2e8f0}}
    @keyframes shake {0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
    .timer-card.pulse {animation:pulseCard .8s ease}
    .timer-card.flash {animation:flashBg 1.2s ease}
    .timer-card.shake {animation:shake .4s ease}
    
    /* Stats cards hover effect */
    .stat-box {
      transition: all 0.3s ease;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 51, 234, 0.05) 100%);
    }
    .stat-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    /* Chart containers */
    .chart-container {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.95) 100%);
      border: 1px solid rgba(226, 232, 240, 0.8);
      transition: all 0.3s ease;
    }
    .chart-container:hover {
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
    }
    
    /* Session list items */
    .session-item {
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }
    .session-item:hover {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.08) 0%, rgba(249, 250, 251, 1) 100%);
      border-left-color: #3b82f6;
      transform: translateX(4px);
    }
    
    /* Timer card gradient */
    .timer-display {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
      border: 2px solid rgba(59, 130, 246, 0.2);
    }
    
    /* Button styles */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }
  </style>

  <script>
    window.bootstrap = {
      userName: "{{ display_name|default:''|escapejs }}",
      suggestion: {{ suggestion|default:50 }},
      streak: {{ streak|default:0 }},
      today_minutes: {{ today_minutes|default:0 }},
      week_minutes: {{ week_minutes|default:0 }},
      running: {% if running %}{
        id: {{ running.id }},
        planned: {{ running.planned_minutes }},
        brk: {{ running.break_minutes }},
        title: "{{ running.title|default_if_none:''|escapejs }}"
      }{% else %}null{% endif %},
      recent: {{ recent_json|safe }}
    };
  </script>
</head>

<body
  x-data="{ page: 'home', darkMode: true, stickyMenu: false, navigationOpen: false, scrollTop: false }"
  x-init="
    darkMode = JSON.parse(localStorage.getItem('darkMode') || 'false');
    $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))
  "
  :class="{'b eh': darkMode === true}"
>

  <!-- ===== Header Start ===== -->
  <header class="g s r vd ya cj" :class="{ 'hh sm _k dj bl ll' : stickyMenu }"
    @scroll.window="stickyMenu = (window.pageYOffset > 20) ? true : false">
    <div class="bb ze ki xn 2xl:ud-px-0 oo wf yf i">
      <div class="vd to/4 tc wf yf">
        <a href="{% url 'home' %}">
          <img class="om" src="{% static 'base_tailwind/images/logo-light.svg' %}" alt="Logo Light">
          <img class="xc nm" src="{% static 'base_tailwind/images/logo-dark.svg' %}" alt="Logo Dark">
        </a>

        <!-- Hamburger Toggle BTN -->
        <button class="po rc" @click="navigationOpen = !navigationOpen">
          <span class="rc i pf re pd">
            <span class="du-block h q vd yc">
              <span class="rc i r s eh um tg te rd eb ml jl dl" :class="{ 'ue el': !navigationOpen }"></span>
              <span class="rc i r s eh um tg te rd eb ml jl fl" :class="{ 'ue qr': !navigationOpen }"></span>
              <span class="rc i r s eh um tg te rd eb ml jl gl" :class="{ 'ue hl': !navigationOpen }"></span>
            </span>
            <span class="du-block h q vd yc lf">
              <span class="rc eh um tg ml jl el h na r ve yc" :class="{ 'sd dl': !navigationOpen }"></span>
              <span class="rc eh um tg ml jl qr h s pa vd rd" :class="{ 'sd rr': !navigationOpen }"></span>
            </span>
          </span>
        </button>
        <!-- Hamburger Toggle BTN -->
      </div>

      <div class="vd wo/4 sd qo f ho oo wf yf" :class="{ 'd hh rm sr td ud qg ug jc yh': navigationOpen }">
        <nav>
          <ul class="tc _o sf yo cg ep">
            <li><a href="{% url 'home' %}" class="xl" :class="{ 'mk': page === 'home' }">Dashboard</a></li>
            <li class="c i" x-data="{ dropdown: false }">
              <a href="#!" class="xl tc wf yf bg" @click.prevent="dropdown = !dropdown"
                :class="{ 'mk': page === 'blog-grid' || page === 'blog-single' || page === 'signin' || page === 'signup' || page === '404' }">
                Pages
                <svg :class="{ 'wh': dropdown }" class="th mm we fd pf" xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 512 512">
                  <path
                    d="M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z" />
                </svg>
              </a>

              <!-- Dropdown Start -->
              <ul class="a" :class="{ 'tc': dropdown }">
                <li><a href="{% url 'study:home' %}" class="xl" :class="{ 'mk': page === 'blog-grid' }">Sessions</a></li>
                <li><a href="projects.html" class="xl" :class="{ 'mk': page === 'blog-single' }">Projects & tasks</a></li>
                <li><a href="agenda.html" class="xl" :class="{ 'mk': page === 'signin' }">Agenda</a></li>
                <li><a href="meetings.html" class="xl" :class="{ 'mk': page === 'signup' }">Meetings</a></li>
                <li><a href="habit&notes.html" class="xl" :class="{ 'mk': page === 'signup' }">Habits & notes</a></li>
              </ul>
              <!-- Dropdown End -->
            </li>
            <li><a href="{% url 'home' %}#support" class="xl">Support</a></li>
          </ul>
        </nav>

        <div class="tc wf ig pb no">
          <div class="pc h io pa ra" :class="navigationOpen ? '!-ud-visible' : 'd'">
            <label class="rc ab i">
              <input type="checkbox" :value="darkMode" @change="darkMode = !darkMode" class="pf vd yc uk h r za ab" />
              <!-- Icon Sun -->
              <svg :class="{ 'wn' : page === 'home', 'xh' : page === 'home' && stickyMenu }" class="th om" width="25"
                height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M12.0908 18.6363C10.3549 18.6363 8.69 17.9467 7.46249 16.7192C6.23497 15.4916 5.54537 13.8268 5.54537 12.0908C5.54537 10.3549 6.23497 8.69 7.46249 7.46249C8.69 6.23497 10.3549 5.54537 12.0908 5.54537C13.8268 5.54537 15.4916 6.23497 16.7192 7.46249C17.9467 8.69 18.6363 10.3549 18.6363 12.0908C18.6363 13.8268 17.9467 15.4916 16.7192 16.7192C15.4916 17.9467 13.8268 18.6363 12.0908 18.6363ZM12.0908 16.4545C13.2481 16.4545 14.358 15.9947 15.1764 15.1764C15.9947 14.358 16.4545 13.2481 16.4545 12.0908C16.4545 10.9335 15.9947 9.8236 15.1764 9.00526C14.358 8.18692 13.2481 7.72718 12.0908 7.72718C10.9335 7.72718 9.8236 8.18692 9.00526 9.00526C8.18692 9.8236 7.72718 10.9335 7.72718 12.0908C7.72718 13.2481 8.18692 14.358 9.00526 15.1764C9.8236 15.9947 10.9335 16.4545 12.0908 16.4545ZM10.9999 0.0908203H13.1817V3.36355H10.9999V0.0908203ZM10.9999 20.8181H13.1817V24.0908H10.9999V20.8181ZM2.83446 4.377L4.377 2.83446L6.69082 5.14828L5.14828 6.69082L2.83446 4.37809V4.377ZM17.4908 19.0334L19.0334 17.4908L21.3472 19.8046L19.8046 21.3472L17.4908 19.0334ZM19.8046 2.83337L21.3472 4.377L19.0334 6.69082L17.4908 5.14828L19.8046 2.83446V2.83337ZM5.14828 17.4908L6.69082 19.0334L4.377 21.3472L2.83446 19.8046L5.14828 17.4908ZM24.0908 10.9999V13.1817H20.8181V10.9999H24.0908ZM3.36355 10.9999V13.1817H0.0908203V10.9999H3.36355Z"
                  fill="" />
              </svg>
              <!-- Icon Moon -->
              <img class="xc nm" src="{% static 'base_tailwind/images/icon-moon.svg' %}" alt="Moon" />
            </label>
          </div>

          <a href="signin.html" :class="{ 'nk yl' : page === 'home', 'ok' : page === 'home' && stickyMenu }"
            class="ek pk xl">Sign In</a>
          <a href="signup.html" :class="{ 'hh/[0.15]' : page === 'home', 'sh' : page === 'home' && stickyMenu }"
            class="lk gh dk rg tc wf xf _l gi hi">Sign Up</a>
        </div>
      </div>
    </div>
  </header>
  <!-- ===== Header End ===== -->

  <!-- ===== Main Layout ===== -->
  <main class="mt-24 lg:mt-28 w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    
    <!-- Statistiques rapides - Full width -->
    <section class="mb-8 animate_top">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="stat-box p-6 rounded-2xl border shadow-sm">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium opacity-70">Aujourd'hui</h3>
            <svg class="w-8 h-8 text-blue-500 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div id="stat-today" class="text-3xl font-bold text-blue-600">{{ today_minutes }}m</div>
          <p class="text-xs opacity-60 mt-1">Temps d'√©tude</p>
        </div>

        <div class="stat-box p-6 rounded-2xl border shadow-sm">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium opacity-70">Cette semaine</h3>
            <svg class="w-8 h-8 text-purple-500 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <div id="stat-week" class="text-3xl font-bold text-purple-600">{{ week_minutes }}m</div>
          <p class="text-xs opacity-60 mt-1">Total hebdomadaire</p>
        </div>

        <div class="stat-box p-6 rounded-2xl border shadow-sm">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium opacity-70">Streak</h3>
            <svg class="w-8 h-8 text-orange-500 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path>
            </svg>
          </div>
          <div id="stat-streak" class="text-3xl font-bold text-orange-600">{{ streak }} üî•</div>
          <p class="text-xs opacity-60 mt-1">Jours cons√©cutifs</p>
        </div>
      </div>
    </section>

    <!-- Main content grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      
      <!-- Sidebar -->
      <aside class="lg:col-span-4 space-y-6">
        
        <!-- Sessions r√©centes -->
        <section class="chart-container p-5 rounded-2xl shadow-sm animate_top">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-lg">Sessions r√©centes</h3>
            <a href="{% url 'study:session_list' %}" class="text-sm text-blue-600 hover:text-blue-700 hover:underline transition">
              Voir tout ‚Üí
            </a>
          </div>
          <ul id="sessionList" class="space-y-2"></ul>
        </section>

        <!-- Charts mini -->
        <section class="chart-container p-5 rounded-2xl shadow-sm animate_top">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">R√©partition par projet</h3>
            <i data-lucide="pie-chart" class="w-5 h-5 text-blue-500"></i>
          </div>
          <canvas id="chart-projects" style="max-height: 180px;"></canvas>
        </section>

        <section class="chart-container p-5 rounded-2xl shadow-sm animate_top">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Score de productivit√©</h3>
            <i data-lucide="sparkles" class="w-5 h-5 text-purple-500"></i>
          </div>
          <div class="text-center py-6">
            <div id="score-productivity" class="text-5xl font-extrabold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">76</div>
            <p class="text-sm opacity-70 mt-2">Bas√© sur focus et r√©gularit√©</p>
          </div>
        </section>

      </aside>

      <!-- Main content -->
      <section class="lg:col-span-8 space-y-6">
        
        <!-- Timer Pomodoro -->
        <div class="chart-container p-6 rounded-2xl shadow-sm animate_top">
          <h3 class="text-xl font-semibold mb-4">‚è±Ô∏è Timer intelligent (Pomodoro)</h3>
          
          <!-- Inputs -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <label class="block text-sm font-medium mb-2">Titre de la session</label>
              <input id="fldTitle" type="text" placeholder="Ex: R√©vision R√©seaux" 
                     class="w-full rounded-xl bg-slate-50 border border-slate-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"/>
            </div>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium mb-2">√âtude (min)</label>
                <input id="inpStudy" type="number" value="{{ suggestion|default:50 }}" 
                       class="w-full rounded-xl bg-slate-50 border border-slate-200 px-3 py-2.5 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition"/>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Repos (min)</label>
                <input id="inpBreak" type="number" value="10" 
                       class="w-full rounded-xl bg-slate-50 border border-slate-200 px-3 py-2.5 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition"/>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2 opacity-0">-</label>
                <button id="btnSuggest" class="w-full px-3 py-2.5 rounded-xl border border-blue-300 hover:bg-blue-50 transition text-sm font-medium text-blue-600">
                  Sugg√©rer
                </button>
              </div>
            </div>
          </div>

          <!-- Timer Display -->
          <div id="timerCard" class="timer-card timer-display rounded-2xl p-8 mb-4">
            <div class="text-center">
              <div id="timerPhase" class="text-sm uppercase tracking-widest font-semibold text-blue-600 mb-2">Focus</div>
              <div id="timerDisplay" class="text-7xl font-bold mb-6 font-mono">--:--</div>
              <div class="flex items-center justify-center gap-3">
                <button id="btnStartServer" class="btn-primary px-6 py-3 rounded-xl text-white font-medium shadow-lg">
                  ‚ñ∂ D√©marrer
                </button>
                <button id="btnPause" class="px-6 py-3 rounded-xl bg-slate-200 hover:bg-slate-300 font-medium transition">
                  ‚è∏ Pause
                </button>
                <button id="btnStopServer" class="px-6 py-3 rounded-xl border-2 border-red-300 text-red-600 hover:bg-red-50 font-medium transition hidden">
                  ‚èπ Arr√™ter
                </button>
              </div>
            </div>
          </div>

          <div class="flex items-start gap-2 text-sm text-blue-600 bg-blue-50 border border-blue-200 rounded-xl p-3">
            <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
            <p><strong>Conseil:</strong> Reste sur cette page pendant ta session pour maximiser ton score de productivit√©.</p>
          </div>

          <input type="hidden" id="runningSessionId" value="{% if running %}{{ running.id }}{% endif %}">
        </div>

        <!-- Chart temps d'√©tude -->
        <div class="chart-container p-6 rounded-2xl shadow-sm animate_top">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-lg">üìä Temps d'√©tude hebdomadaire</h3>
            <i data-lucide="bar-chart-3" class="w-5 h-5 text-blue-500"></i>
          </div>
          <canvas id="chart-week" style="max-height: 250px;"></canvas>
        </div>

      </section>

    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-6 right-6 px-5 py-3 rounded-xl bg-slate-900 text-white shadow-2xl text-sm font-medium z-50">
    Message
  </div>

  <!-- ====== Back To Top Start ===== -->
  <button class="xc wf xf ie ld vg sr gh tr g sa ta _a" @click="window.scrollTo({top: 0, behavior: 'smooth'})"
    @scroll.window="scrollTop = (window.pageYOffset > 50) ? true : false" :class="{ 'uc' : scrollTop }">
    <svg class="uh se qd" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
      <path d="M233.4 105.4c12.5-12.5 32.8-12.5 45.3 0l192 192c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L256 173.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l192-192z" />
    </svg>
  </button>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-4 right-4 p-3 rounded-xl bg-slate-900 text-white shadow-lg text-sm">OK</div>

  <!-- ===== JS d‚Äôint√©gration ===== -->
  <script>
    /* ---------- Navigation ---------- */
    const views={dashboard:document.getElementById('view-dashboard'),study:document.getElementById('view-study'),projects:document.getElementById('view-projects'),planner:document.getElementById('view-planner'),analytics:document.getElementById('view-analytics'),habits:document.getElementById('view-habits'),meetings:document.getElementById('view-meetings')};
    function showView(id){Object.values(views).forEach(v=>v.classList.add('hidden'));views[id]?.classList.remove('hidden')}
    document.querySelectorAll('.nav-btn').forEach(b=>b.addEventListener('click',()=>showView(b.dataset.target)));
    const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.classList.remove('hidden');setTimeout(()=>t.classList.add('hidden'),1600)}
    lucide.createIcons();

    /* ---------- Helpers DOM ---------- */
    const sessionList=document.getElementById('sessionList');
    function renderRecent(list){
      if(!list||!list.length){ sessionList.innerHTML='<li>Aucune session.</li>'; return; }
      sessionList.innerHTML=list.map(s=>`
        <li class="p-2 rounded-lg bg-slate-50 flex items-center justify-between">
          <span>${s.title||'Session'} ‚Äî ${s.is_running ? '<span class="text-blue-600">en cours</span>' : (s.duration_minutes+' min')}</span>
          <span class="opacity-70">${new Date(s.started_at).toLocaleDateString()}</span>
        </li>`).join('');
    }
    try{ renderRecent(JSON.parse(window.bootstrap.recent||"[]")); }catch{ renderRecent([]); }

    function setStats({today_minutes,week_minutes,streak}){
      document.getElementById('stat-today').textContent=`${today_minutes}m`;
      document.getElementById('stat-week').textContent=`${week_minutes}m`;
      document.getElementById('stat-streak').textContent=`${streak}üî•`;
    }

    /* ---------- CSRF & API ---------- */
    function getCookie(name){const v=`; ${document.cookie}`.split(`; ${name}=`);if(v.length===2)return v.pop().split(';').shift();}
    const csrftoken=getCookie('csrftoken');

    async function apiStart({title,study,brk}){
      const fd=new FormData(); fd.append('title',title||''); fd.append('planned_minutes',study||50); fd.append('break_minutes',brk||10);
      const r=await fetch("{% url 'study:api_session_start' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken},body:fd});
      if(!r.ok) throw new Error('start failed'); return r.json();
    }
    async function apiStop(id){
      const fd=new FormData(); fd.append('session_id',id);
      const r=await fetch("{% url 'study:api_session_stop' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken},body:fd});
      if(!r.ok) throw new Error('stop failed'); return r.json();
    }
    async function apiSummary(){
      const r=await fetch("{% url 'study:api_summary' %}"); if(!r.ok) throw new Error('summary failed'); return r.json();
    }

    /* ---------- Timer ---------- */
    let runningId=document.getElementById('runningSessionId').value || (window.bootstrap.running?window.bootstrap.running.id:"");
    let studyMinutes=window.bootstrap.running?window.bootstrap.running.planned:(window.bootstrap.suggestion||50);
    let breakMinutes=window.bootstrap.running?window.bootstrap.running.brk:10;
    let isBreak=false, remaining=(studyMinutes*60), timer=null, productivity=76;

    const disp=document.getElementById('timerDisplay'), phase=document.getElementById('timerPhase'), card=document.getElementById('timerCard');
    function updateDisplay(){const m=String(Math.floor(remaining/60)).padStart(2,'0');const s=String(remaining%60).padStart(2,'0');disp.textContent=`${m}:${s}`;phase.textContent=isBreak?'Repos':'Focus';}
    function animate(cls){card.classList.remove('pulse','flash','shake');void card.offsetWidth;card.classList.add(cls);setTimeout(()=>card.classList.remove(cls),700);}
    function beep(freq=880,ms=220){try{const C=window.AudioContext||window.webkitAudioContext;const ctx=new C();const o=ctx.createOscillator();const g=ctx.createGain();o.type='sine';o.frequency.value=freq;o.connect(g);g.connect(ctx.destination);o.start();g.gain.setValueAtTime(0.15,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+ms/1000);o.stop(ctx.currentTime+ms/1000);}catch{}}
    function notify(msg){if('vibrate'in navigator) navigator.vibrate(100); toast(msg);}

    function startLocal(){ if(timer) return; timer=setInterval(()=>{ remaining--; if(remaining<=0){ isBreak=!isBreak; remaining=(isBreak?breakMinutes:studyMinutes)*60; animate('flash'); beep(isBreak?660:880,260); notify(isBreak?'Pause !':'Go Focus !'); } updateDisplay(); },1000); document.title='‚è±Ô∏è En cours ‚Äî Personal Tracker'; animate('pulse'); }
    function pauseLocal(){ if(timer){ clearInterval(timer); timer=null; document.title='Personal Tracker'; animate('shake'); } }
    document.addEventListener('visibilitychange',()=>{ if(document.hidden&&timer){ productivity=Math.max(0,productivity-1);} });

    const btnStart=document.getElementById('btnStartServer'), btnStop=document.getElementById('btnStopServer'), btnPause=document.getElementById('btnPause');
    function setRunningUI(r){ if(r){ btnStop.classList.remove('hidden'); btnStart.disabled=true; } else { btnStop.classList.add('hidden'); btnStart.disabled=false; } }

    updateDisplay(); if(runningId){ setRunningUI(true); startLocal(); } else { setRunningUI(false); }

    // Suggestion
    const btnSuggest=document.getElementById('btnSuggest'), inpStudy=document.getElementById('inpStudy'), inpBreak=document.getElementById('inpBreak');
    btnSuggest.addEventListener('click',()=>{const sugg=window.bootstrap.suggestion||50; inpStudy.value=sugg; if(!runningId&&!isBreak){ studyMinutes=sugg; remaining=sugg*60; updateDisplay(); } toast(`Suggestion: ${sugg} min`);});

    // START
    btnStart.addEventListener('click',async()=>{
      try{
        const data=await apiStart({title:document.getElementById('fldTitle').value, study:inpStudy.value, brk:inpBreak.value});
        runningId=data.session_id; studyMinutes=parseInt(inpStudy.value||'50',10); breakMinutes=parseInt(inpBreak.value||'10',10);
        isBreak=false; remaining=studyMinutes*60; updateDisplay(); startLocal(); setRunningUI(true); beep(880,220); toast('Session d√©marr√©e !');
        const sum=await apiSummary(); renderRecent(sum.recent);
      }catch{ toast('Erreur d√©marrage'); }
    });

    // STOP
    btnStop.addEventListener('click',async()=>{
      try{
        await apiStop(runningId);
        pauseLocal(); runningId=""; setRunningUI(false); beep(520,250); notify('Session arr√™t√©e !');
        const sum=await apiSummary();
        renderRecent(sum.recent); setStats(sum);
        isBreak=false; remaining=(parseInt(inpStudy.value||'50',10))*60; updateDisplay();
      }catch{ toast('Erreur arr√™t'); }
    });

    btnPause.addEventListener('click',()=>{ timer ? pauseLocal() : startLocal(); });

    /* ---------- Charts & Calendar (d√©mo) ---------- */
    function refreshCharts(){
      const ctxW=document.getElementById('chart-week');
      const ctxP=document.getElementById('chart-projects');
      const ctxT=document.getElementById('chart-trend');
      const ctxB=document.getElementById('chart-bars');
      const days=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
      const weekData=days.map(()=>Math.round(Math.random()*120));
      const projLabels=['M√©moire IA','App Web Django','Cours R√©seaux'];
      const projData=[390,210,540];
      new Chart(ctxW,{type:'line',data:{labels:days,datasets:[{label:'Minutes',data:weekData,tension:.35,fill:true}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
      new Chart(ctxP,{type:'doughnut',data:{labels:projLabels,datasets:[{data:projData}]},options:{plugins:{legend:{position:'bottom'}}}});
      new Chart(ctxT,{type:'line',data:{labels:[...Array(10)].map((_,i)=>`S${i+1}`),datasets:[{label:'Score',data:[60,62,65,63,66,70,72,75,77,76],tension:.35,fill:true}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100}}}});
      new Chart(ctxB,{type:'bar',data:{labels:projLabels,datasets:[{label:'Minutes',data:projData}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    }
    function initCalendar(){
      const el=document.getElementById('calendar');
      if(!el) return;
      const cal=new FullCalendar.Calendar(el,{
        initialView:'dayGridMonth',
        height:650,
        headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek'},
        events:[]
      });
      cal.render();
    }

    showView('study');
    refreshCharts();
    initCalendar();
  </script>
</body>
</html>
