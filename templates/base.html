{% load static %}
<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Personal Study & Project Tracker{% endblock %}</title>
    <link rel="icon" href="{% static 'base_tailwind/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'base_tailwind/style.css' %}">
    <meta name="description" content="Application Web — Suivi d'étude, gestion de projets, tâches, habitudes, notes et analytics." />
    <meta name="theme-color" content="#0f172a" />
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind config: couleurs personnalisées
        tailwind.config = { 
            theme: { 
                extend: { 
                    colors: { 
                        brand: { 
                            50:'#eff6ff',100:'#dbeafe',200:'#bfdbfe',
                            300:'#93c5fd',400:'#60a5fa',500:'#3b82f6',
                            600:'#2563eb',700:'#1d4ed8',800:'#1e40af',
                            900:'#1e3a8a'
                        } 
                    } 
                } 
            } 
        }
    </script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="stylesheet" href="{% static 'base_tailwind/style.css' %}">
    
    {% block extra_head %}
    <style>
    .fade-in { animation: fadeIn .3s ease; }
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    @keyframes pulseCard {0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
    @keyframes flashBg {0%{background:#e2e8f0}50%{background:#bfdbfe}100%{background:#e2e8f0}}
    @keyframes shake {0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
    .timer-card.pulse {animation:pulseCard .8s ease}
    .timer-card.flash {animation:flashBg 1.2s ease}
    .timer-card.shake {animation:shake .4s ease}
    
    /* Stats cards hover effect */
    .stat-box {
      transition: all 0.3s ease;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 51, 234, 0.05) 100%);
    }
    .stat-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    /* Chart containers */
    .chart-container {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.95) 100%);
      border: 1px solid rgba(226, 232, 240, 0.8);
      transition: all 0.3s ease;
    }
    .chart-container:hover {
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
    }
    
    /* Session list items */
    .session-item {
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }
    .session-item:hover {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.08) 0%, rgba(249, 250, 251, 1) 100%);
      border-left-color: #3b82f6;
      transform: translateX(4px);
    }
    
    /* Timer card gradient */
    .timer-display {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
      border: 2px solid rgba(59, 130, 246, 0.2);
    }
    
    /* Button styles */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    {% endblock %}
</head>
    <body {% block body_attributes %}class="h-full bg-slate-50 text-brand-900 dark:bg-slate-900 dark:text-slate-300" {% block body_x_data %}x-data="{ page: 'home', 'darkMode': true, 'stickyMenu': false, 'navigationOpen': false, 'scrollTop': false }"{% endblock body_x_data %} {% block body_x_init %}x-init="
         darkMode = JSON.parse(localStorage.getItem('darkMode'));
         $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"{% endblock body_x_init %}
  :class="{'b eh': darkMode === true}"{% endblock body_attributes %}>
    <!-- Top Nav -->
    <header class="sticky top-0 z-40 bg-white/80 dark:bg-slate-900/70 glass border-b border-slate-200/60 dark:border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center gap-3">
            <div class="flex items-center gap-2">
                <div class="h-9 w-9 rounded-2xl bg-gradient-to-br from-brand-500 to-indigo-600 grid place-items-center text-white font-bold">PT</div>
                    <span class="font-semibold text-brand-900 dark:text-brand-400">Personal Tracker</span>
            </div>
            <nav class="ml-6 hidden md:flex items-center gap-2 text-sm">
                {% if user.is_authenticated %}
                        <a href="{% url 'Gestion_Projects:project_list' %}" data-onboard="true" data-onboard-order="1" data-onboard-text="Accédez à la liste de vos projets depuis ici." class="nav-btn px-3 py-2 rounded-xl text-brand-900 dark:text-brand-400 hover:bg-slate-100 dark:hover:bg-slate-800">
                            Mes Projets
                        </a>
                    <form method="post" action="{% url 'Gestion_Projects:logout' %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="nav-btn px-3 py-2 rounded-xl text-brand-900 dark:text-brand-400 hover:bg-slate-100 dark:hover:bg-slate-800">
                            Déconnexion
                        </button>
                    </form>
                {% endif %}
            </nav>
            <div class="ml-auto flex items-center gap-2">
                <!-- Recherche -->
                <label class="relative hidden sm:block">
              <input type="search" name="search" placeholder="Rechercher..." value="{{ search_query|default:'' }}" 
                  data-onboard="true" data-onboard-order="2" data-onboard-text="Utilisez la recherche pour trouver un projet ou une tâche rapidement." 
                  class="w-64 rounded-xl bg-slate-100 dark:bg-slate-800/80 px-9 py-2 text-brand-900 dark:text-slate-300 placeholder:text-slate-500 dark:placeholder:text-slate-400 outline-none focus:ring-2 ring-brand-500" />
                    <i data-lucide="search" class="w-4 h-4 absolute left-3 top-2.5 opacity-60"></i>
                </label>
                
                <!-- Dark mode toggle -->
                <button id="themeToggle" class="px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800" title="Thème clair/sombre">
                    <i data-lucide="moon" class="w-5 h-5"></i>
                </button>
                
                <!-- Profil -->
                {% if user.is_authenticated %}
                    <div class="flex items-center gap-2 px-2 py-1 rounded-xl bg-slate-100 dark:bg-slate-800/80">
                        <span data-onboard="true" data-onboard-order="4" data-onboard-text="Accédez à votre profil et paramètres ici." class="text-sm font-medium text-brand-900 dark:text-brand-400">{{ user.username }}</span>
                    <img class="h-8 w-8 rounded-full" src="https://i.pravatar.cc/64?img=13" alt="avatar" />
                </div>
                {% else %}
                <a href="{% url 'login' %}" class="px-3 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white">
                    Connexion
                </a>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- Main Content -->
    {% block main_content %}
    <main class="{% block main_classes %}max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6{% endblock main_classes %}">
        {% if messages %}
        <div class="mb-6 space-y-2">
            {% for message in messages %}
            <div class="p-4 rounded-xl {% if message.tags == 'success' %}bg-green-100 text-green-700 border border-green-200
                       {% elif message.tags == 'error' %}bg-red-100 text-red-700 border border-red-200
                       {% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-700 border border-yellow-200
                       {% else %}bg-blue-100 text-blue-700 border border-blue-200{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% block content %}{% endblock content %}
    </main>
    {% endblock main_content %}

    <!-- Floating action button (nouveau projet) -->
    <a href="{% url 'Gestion_Projects:project_create' %}" data-onboard="true" data-onboard-order="3" data-onboard-text="Créez un nouveau projet rapidement depuis ce bouton." class="fab" title="Nouveau projet">+
        <span class="sr-only">Nouveau projet</span>
    </a>

    <!-- Toast -->
    <div id="toast" class="hidden fixed bottom-4 right-4 p-3 rounded-xl bg-slate-900 text-white shadow-lg text-sm">
        Action effectuée
    </div>

    <!-- Onboarding overlay + tooltip (injected once) -->
    <div id="onboardOverlay" class="onboard-overlay" aria-hidden="true"></div>
    <div id="onboardTip" class="onboard-tip" role="dialog" aria-modal="true" style="display:none">
        <div id="onboardTipText"></div>
        <div class="actions">
            <button id="onboardSkip">Passer</button>
            <button id="onboardNext" class="primary">Suivant</button>
        </div>
    </div>

    <!-- Footer: Chatbot (coming soon) -->
    <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="p-4 rounded-2xl bg-white dark:bg-slate-800/60 border border-slate-200 dark:border-slate-700 flex items-center justify-between gap-4 card-accent">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 flex items-center justify-center bg-gradient-to-br from-brand-500 to-indigo-600 rounded-full shadow-sm robot-badge">
                    <!-- simple robot SVG icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="robot-svg">
                        <rect x="3" y="7" width="18" height="10" rx="2" />
                        <path d="M7 7V5a3 3 0 0 1 6 0v2" />
                        <path d="M9 12h.01M15 12h.01" />
                        <path d="M9 17v1a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-1" />
                    </svg>
                </div>
                <div>
                    <div class="text-sm font-semibold text-brand-900 dark:text-slate-100">Assistant Chatbot — bientôt</div>
                    <div class="text-xs opacity-70">Un assistant IA pour vous aider à planifier vos révisions et tâches.</div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <a href="#" class="btn-ghost" aria-disabled="true">En savoir plus</a>
            </div>
        </div>
    </footer>

    <!-- Scripts communs -->
    <script>
        // Thème sombre/clair
        const themeToggle = document.getElementById('themeToggle');
        const root = document.documentElement;
        const pref = localStorage.getItem('pt-theme');
        if (pref === 'dark' || (!pref && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('pt-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });

        // Initialisation des icônes
        lucide.createIcons();

        // Animate progress bars (look for elements with .progress-bar and data-progress)
        document.addEventListener('DOMContentLoaded', function(){
            document.querySelectorAll('.progress-bar').forEach(function(el){
                const target = el.dataset.progress || el.getAttribute('data-progress') || el.getAttribute('aria-valuenow');
                const pct = Math.max(0, Math.min(100, parseFloat(target || 0)));
                // small timeout to allow paint
                setTimeout(() => { el.style.width = pct + '%'; }, 120);
            });

            // Count-up elements: animate numbers from 0 to data-target
            document.querySelectorAll('[data-count-target]').forEach(function(el){
                const target = parseInt(el.dataset.countTarget || '0', 10);
                let current = 0;
                const step = Math.max(1, Math.round(target / 40));
                const id = setInterval(()=>{
                    current += step;
                    if(current >= target){ current = target; el.textContent = target; clearInterval(id); }
                    else { el.textContent = current; }
                }, 18);
            });
        });

        // Simple onboarding tour (shows once)
        (function(){
            const seen = localStorage.getItem('pt-onboard-seen');
            if(seen) return; // already shown

            // Collect nodes with data-onboard and sort by order
            const nodes = Array.from(document.querySelectorAll('[data-onboard]'))
                .map(n => ({ el: n, order: parseInt(n.dataset.onboardOrder||'999',10), text: n.dataset.onboardText||'' }))
                .sort((a,b)=>a.order - b.order);
            if(!nodes.length) return;

            const overlay = document.getElementById('onboardOverlay');
            const tip = document.getElementById('onboardTip');
            const tipText = document.getElementById('onboardTipText');
            const btnNext = document.getElementById('onboardNext');
            const btnSkip = document.getElementById('onboardSkip');

            let idx = 0;

            function showIndex(i){
                const node = nodes[i];
                if(!node) return finish();
                const rect = node.el.getBoundingClientRect();
                tipText.textContent = node.text || 'Astuce';
                // Position tip above element if enough space else below
                const topAbove = rect.top - 16 - tip.offsetHeight;
                let top = Math.max(16, rect.top + window.scrollY - tip.offsetHeight - 12);
                if(top < 8) top = rect.bottom + window.scrollY + 12; // position below
                const left = Math.max(12, rect.left + window.scrollX + (rect.width/2) - (tip.offsetWidth/2));
                // show overlay + tip
                overlay.style.display = 'block';
                tip.style.display = 'block';
                // small timeout to ensure offsetWidth/Height are available
                setTimeout(()=>{
                    tip.style.top = (top) + 'px';
                    tip.style.left = (left) + 'px';
                }, 10);
            }

            function next(){ idx++; if(idx >= nodes.length) finish(); else showIndex(idx); }
            function finish(){ overlay.style.display='none'; tip.style.display='none'; localStorage.setItem('pt-onboard-seen','1'); }

            // wire buttons
            btnNext.addEventListener('click', ()=> next());
            btnSkip.addEventListener('click', ()=> finish());

            // start after short delay so elements render
            setTimeout(()=> showIndex(0), 350);
        })();

        // Toast helper
        function toast(msg){ 
            const t = document.getElementById('toast'); 
            t.textContent = msg; 
            t.classList.remove('hidden'); 
            setTimeout(() => t.classList.add('hidden'), 2000); 
        }
    </script>

    {% block extra_scripts %}{% endblock extra_scripts %}
    <script src="{% static 'base_tailwind/bundle.js' %}"></script>
</body>
</html>